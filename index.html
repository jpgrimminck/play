<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Play</title>

    <!-- ================================
         iOS PWA Meta Tags
         ================================ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Play">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ================================
         Responsive Meta Tag
         ================================ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ============== FAVICONS ============== -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- ================================
         Estilos globales
         ================================ -->
    <style>
        /* ---- Diseño global ---- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #363739; /* Dark background chosen by user */
        }

        /* Barra lateral con miniaturas */
        .sidebar {
            width: 100px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Momentum scroll on iOS   */
            margin-top: calc(-1 * env(safe-area-inset-top)); /* Extend under status‑bar */
            flex-shrink: 0;
        }

        /* Botón individual de miniatura */
        .sidebar .miniatura {
            position: relative;
            width: 100px;
            aspect-ratio: 1/1;   /* Keep square */
            padding: 0;
            margin: 0;
            font-size: 0;        /* Hide text node space */
            background-size: cover;
            background-position: center;
            border: none;
            cursor: pointer;
        }
        .sidebar .miniatura::after {   /* Number overlay */
            content: attr(data-label);
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 14px;
            background: black;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .sidebar .miniatura:hover { filter: brightness(1.3); }

        /* ---- Columna principal del reproductor ---- */
        .main {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            height: 100vh;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        /* Carátula del álbum */
        .caratula {
            width: 200px;
            height: 200px;
            border-radius: 30px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
        }

        /* Estilos tipográficos de canción y artista */
        .info { width: 200px; text-align: left; }
        .nombreCancion {
            font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Helvetica Neue', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: #FFFFFF;
        }
        .artista {
            font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Helvetica Neue', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            color: #B3B3B3;
        }

        /* Controles de medios */
        #seekBar { width: 80%; }

        #playPause {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            background: white;
            color: black;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #playPause:hover { background: #eee; }

        /* Figuras dinámicas del ícono play/pause */
        .icon { width: 0; height: 0; border-style: solid; }
        .play-icon  { border-width: 20px 0 20px 35px; border-color: transparent transparent transparent black; }
        .pause-icon { display: flex; gap: 10px; }
        .pause-icon div { width: 10px; height: 40px; background: black; }

        /* Botón para alternar guitarra (solo en pistas con _sg.mp3) */
        #guitarraBtn {
            position: absolute;
            top: calc(50% - 310px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;

            display: none;                /* default hidden */
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: white;
            box-shadow: 0 0 10px gray;
            cursor: pointer;

            align-items: center;
            justify-content: center;
        }
        #guitarraBtn.active { box-shadow: 0 0 10px red !important; }

        /* Marca de agua de versión */
        .version {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 16px;
            color: #999;
        }
    </style>
</head>

<body>
    <div class="container" style="display:flex; height:100vh;">
        <!-- ========== BARRA LATERAL (Miniaturas) ========== -->
        <div class="sidebar">
            <div id="miniaturasContainer"></div>
        </div>

        <!-- ========== PANEL PRINCIPAL DEL REPRODUCTOR ========== -->
        <div class="main">
            <!-- Botón opcional sin guitarra -->
            <button id="guitarraBtn" title="Alternar guitarra">
                <span style="font-size:28px;">🎸</span>
            </button>

            <!-- Carátula -->
            <div id="cover" class="caratula"></div>

            <!-- Título y artista -->
            <div class="info">
                <div id="nombreCancion" class="nombreCancion"></div>
                <div id="artista"       class="artista"></div>
            </div>

            <!-- Barra de progreso y botón play/pause -->
            <input type="range" id="seekBar" value="0" min="0" step="1">
            <button id="playPause"><div id="icon" class="icon play-icon"></div></button>
        </div>
    </div>

    <!-- ========== PIE DE PÁGINA ========= -->
    <div class="version">Versión 4.0</div>

    <!-- ========== ETIQUETAS DE AUDIO ========= -->
    <audio id="audio"></audio>
    <audio id="audioAlt" style="display:none;"></audio>

    <!-- ================================
         Script de la aplicación
         ================================ -->
    <script>
        /* --------------------------------
           Configuración y metadatos
        -------------------------------- */
        const TOTAL_COVERS          = 10;            // Total de pistas
        const COVERS_CON_GUITARRA   = [9, 10];       // Pistas con mezcla alternativa sin guitarra

        // Metadatos de canciones (título y artista)
        const METADATOS = {
            1 : { nombre: 'Día de Enero',                         artista: 'Shakira' },
            2 : { nombre: 'Hey Jude',                             artista: 'Beatles' },
            3 : { nombre: 'The Scientist',                        artista: 'Coldplay' },
            4 : { nombre: 'Shake it off',                         artista: 'Taylor Swift' },
            5 : { nombre: 'Main Theme',                           artista: 'Gravity Falls' },
            6 : { nombre: 'Riptide',                              artista: 'Vance Joy' },
            7 : { nombre: 'El Camión de Samu',                    artista: 'Hermanos' },
            8 : { nombre: 'Capaz',                                artista: 'Alleh & Yorghaki' },
            9 : { nombre: 'Drive',                                artista: 'Incubus' },
            10: { nombre: "Back to december (Taylor's Version)", artista: 'Taylor Swift' }
        };

        /* --------------------------------
           Elementos del DOM
        -------------------------------- */
        const miniaturasContainer = document.getElementById('miniaturasContainer');
        const nombreCancionEl     = document.getElementById('nombreCancion');
        const artistaEl           = document.getElementById('artista');
        const coverEl             = document.getElementById('cover');
        const seekBar             = document.getElementById('seekBar');

        const playPauseBtn        = document.getElementById('playPause');
        const icon                = document.getElementById('icon');
        const guitarraBtn         = document.getElementById('guitarraBtn');

        const audio        = document.getElementById('audio');
        const audioAlt     = document.getElementById('audioAlt');
        let   currentAudio = audio;      // <audio> actualmente activo
        let   isAlt        = false;      // true si está sonando la mezcla sin guitarra

        /* --------------------------------
           Ayudante: actualizar ícono play/pause
        -------------------------------- */
        function setIcon(state) {
            if (state === 'play') {
                icon.className = 'icon play-icon';
                icon.innerHTML = ''; // Triangle via CSS borders
            } else {
                icon.className = 'pause-icon';
                icon.innerHTML = '<div></div><div></div>';
            }
        }

        /* --------------------------------
           Seleccionar una nueva pista para reproducir
        -------------------------------- */
        function selectAudio(filename, coverImage, meta) {
            // Pause any current audio
            if (currentAudio && !currentAudio.paused) currentAudio.pause();

            // Update primary audio source
            audio.src = filename;

            // Persist user selection in localStorage
            localStorage.setItem('selectedAudio',  filename);
            localStorage.setItem('selectedCover',  coverImage);
            localStorage.setItem('selectedNombre', meta.nombre);
            localStorage.setItem('selectedArtista',meta.artista);

            // UI updates
            coverEl.style.backgroundImage = `url('${coverImage}')`;
            nombreCancionEl.textContent   = meta.nombre;
            artistaEl.textContent         = meta.artista;

            // Media Session API (lock‑screen controls)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title:  meta.nombre,
                    artist: meta.artista,
                    artwork: [{ src: coverImage, sizes: '512x512', type: 'image/jpeg' }]
                });

                navigator.mediaSession.setActionHandler('play',  () => { currentAudio.play();  setIcon('pause'); });
                navigator.mediaSession.setActionHandler('pause', () => { currentAudio.pause(); setIcon('play');  });
            }

            /* --- Handle optional guitar‑mute track --- */
            const index = parseInt(filename.match(/(\d+)\.mp3/)[1]);

            if (COVERS_CON_GUITARRA.includes(index)) {
                guitarraBtn.style.display = 'flex';
                guitarraBtn.disabled      = true;      // esperar precarga
                guitarraBtn.classList.remove('active');
                guitarraBtn.style.filter  = 'grayscale(100%)';
                guitarraBtn.style.opacity = '0.6';

                // Prepare alternate mix
                audioAlt.src    = filename.replace('.mp3', '_sg.mp3');
                audioAlt.preload = 'auto';
                audioAlt.load();
                audioAlt.addEventListener('canplaythrough', () => {
                    guitarraBtn.disabled = false;
                    guitarraBtn.style.filter  = 'none';
                    guitarraBtn.style.opacity = '1';
                }, { once: true });

            } else {
                guitarraBtn.style.display = 'none';
            }

            // Reset playback state
            currentAudio = audio;
            currentAudio.load();
            seekBar.value = 0;
            seekBar.max   = 1;
            setIcon('play');
        }

        /* --------------------------------
           Toggle play / pause button
        -------------------------------- */
        function togglePlay() {
            if (!currentAudio.src) return;   // nada cargado aún
            if (currentAudio.paused) {
                currentAudio.play();
                setIcon('pause');
            } else {
                currentAudio.pause();
                setIcon('play');
            }
        }

        /* --------------------------------
           Actualizaciones de tiempo del elemento de audio
        -------------------------------- */
        [audio, audioAlt].forEach(aud => {
            aud.addEventListener('ended',     ()  => setIcon('play'));
            aud.addEventListener('timeupdate', e  => {
                if (!isNaN(e.target.duration)) {
                    seekBar.max   = Math.floor(e.target.duration);
                    seekBar.value = Math.floor(e.target.currentTime);
                }
            });
        });

        /* --------------------------------
           Manejador de arrastre de la barra de progreso
        -------------------------------- */
        seekBar.addEventListener('input', () => { currentAudio.currentTime = seekBar.value; });

        /* --------------------------------
           Restaurar última sesión al cargar
        -------------------------------- */
        window.addEventListener('DOMContentLoaded', () => {
            // Cargar selecciones persistidas o valores por defecto
            const savedAudio  = localStorage.getItem('selectedAudio')  || '1.mp3';
            const savedCover  = localStorage.getItem('selectedCover')  || 'cover1.jpeg';
            const savedName   = localStorage.getItem('selectedNombre') || METADATOS[1].nombre;
            const savedArt    = localStorage.getItem('selectedArtista')|| METADATOS[1].artista;
            const savedIsAlt  = localStorage.getItem('isAlt') === 'true';

            coverEl.style.backgroundImage = `url('${savedCover}')`;
            nombreCancionEl.textContent   = savedName;
            artistaEl.textContent         = savedArt;

            audio.src = savedAudio;

            const index = parseInt(savedAudio.match(/(\d+)\.mp3/)[1]);

            // Mostrar u ocultar botón de guitarra
            guitarraBtn.style.display = COVERS_CON_GUITARRA.includes(index) ? 'flex' : 'none';

            // Si el usuario salió con mezcla alternativa, retomarla
            if (COVERS_CON_GUITARRA.includes(index) && savedIsAlt) {
                isAlt = true;
                guitarraBtn.classList.add('active');
                audioAlt.src = savedAudio.replace('.mp3', '_sg.mp3');
                currentAudio = audioAlt;
            } else {
                currentAudio = audio;
            }

            // Construir miniaturas en la barra lateral (orden inverso, más recientes arriba)
            for (let i = TOTAL_COVERS; i >= 1; i--) {
                const btn = document.createElement('button');
                btn.className = 'miniatura';
                btn.dataset.label = i;
                btn.style.backgroundImage = `url('cover${i}.jpeg')`;
                btn.onclick = () => selectAudio(`${i}.mp3`, `cover${i}.jpeg`, METADATOS[i]);
                miniaturasContainer.appendChild(btn);
            }
        });

        /* --------------------------------
           Escuchadores de eventos para controles
        -------------------------------- */
        playPauseBtn.addEventListener('click', togglePlay);

        guitarraBtn.addEventListener('click', () => {
            const savedAudio = localStorage.getItem('selectedAudio');
            const index      = parseInt(savedAudio.match(/(\d+)\.mp3/)[1]);

            if (!COVERS_CON_GUITARRA.includes(index)) return;

            const time    = currentAudio.currentTime;
            const wasPlay = !currentAudio.paused;

            // Alternar clase activa
            guitarraBtn.classList.toggle('active');
            isAlt = guitarraBtn.classList.contains('active');
            localStorage.setItem('isAlt', isAlt.toString());

            // Cambiar elementos de audio
            currentAudio.pause();
            currentAudio = isAlt ? audioAlt : audio;
            currentAudio.currentTime = time;
            if (wasPlay) currentAudio.play();
        });
    </script>
</body>
</html>
